{% extends 'base.html' %}

{% block title %}Messages - Apartment Reservation{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="header-text">
            <h1>Messages</h1>
            <p>Manage your conversations with tenants and staff</p>
        </div>
        <a href="{% url 'send_message' %}" class="btn btn-primary">+ New Message</a>
    </div>

    <div class="inbox-wrapper">
        {% if conversation_data %}
            <div class="conversation-list">
                {% for data in conversation_data %}
                <div class="conversation-row {% if data.unread_count > 0 %}unread{% endif %}" 
                     onclick="window.location='{% url 'message_detail' data.conversation.pk %}'">
                    
                    <div class="conv-avatar">
                        <span class="avatar-circle">
                            {{ data.other_user.username|slice:":1"|upper }}
                        </span>
                    </div>
                    
                    <div class="conv-main">
                        <div class="conv-header">
                            <div class="user-info">
                                <strong class="conv-user">{{ data.other_user.get_full_name|default:data.other_user.username }}</strong>
                                {% if data.other_user.is_staff %}
                                    <span class="badge-admin">Staff</span>
                                {% endif %}
                            </div>
                            <div class="conv-meta-mobile">
                                {% if data.last_message %}
                                    {{ data.last_message.created_at|timesince }} ago
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="conv-subject">{{ data.conversation.subject }}</div>
                        
                        <div class="conv-preview">
                            {% if data.last_message %}
                                <span class="preview-sender">
                                    {% if data.last_message.sender == user %}You:{% else %}{{ data.last_message.sender.username }}:{% endif %}
                                </span>
                                <span class="preview-text">{{ data.last_message.content|truncatechars:60 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="conv-meta-desktop">
                        {% if data.unread_count > 0 %}
                            <span class="unread-badge">{{ data.unread_count }}</span>
                        {% endif %}
                        {% if data.last_message %}
                            <span class="conv-date">{{ data.last_message.created_at|timesince }} ago</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-visual">No Messages</div>
                <h3>No conversations yet</h3>
                <p>Start a conversation by clicking "New Message" above</p>
            </div>
        {% endif %}
    </div>
</div>

<style>
    /* Wrapper */
    .inbox-wrapper {
        max-width: 1000px;
        margin: 1.5rem auto;
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        border: 1px solid var(--gray-200);
    }

    .conversation-list { display: flex; flex-direction: column; }

    /* Row Layout */
    .conversation-row {
        display: grid;
        grid-template-columns: 64px 1fr 140px;
        gap: 1rem;
        padding: 1.25rem;
        border-bottom: 1px solid var(--gray-100);
        cursor: pointer;
        transition: background 0.2s;
        align-items: center;
    }

    .conversation-row:hover { background: var(--gray-50); }

    .conversation-row.unread {
        background: #f0f7ff;
        border-left: 4px solid var(--primary);
    }

    /* Avatar */
    .avatar-circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--dark);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
    }

    /* Main Content */
    .conv-main { min-width: 0; }
    .conv-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .user-info { display: flex; align-items: center; gap: 8px; }
    
    .conv-user { color: var(--dark); font-size: 1rem; }
    .conv-subject { color: var(--primary); font-weight: 700; font-size: 0.95rem; margin-bottom: 2px; }
    .conv-preview { color: var(--gray-500); font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .preview-sender { font-weight: 700; color: var(--gray-700); }

    /* Meta & Badges */
    .conv-meta-desktop { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
    .conv-meta-mobile { display: none; font-size: 0.75rem; color: var(--gray-400); }
    .conv-date { color: var(--gray-400); font-size: 0.8rem; }

    .badge-admin { 
        background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 4px; 
        font-size: 0.65rem; font-weight: 800; text-transform: uppercase; 
    }

    .unread-badge {
        background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px;
        font-size: 0.7rem; font-weight: 800;
    }

    /* Empty State */
    .empty-state { text-align: center; padding: 5rem 2rem; background: var(--gray-50); }
    .empty-visual { 
        font-weight: 800; font-size: 1rem; color: var(--gray-300); 
        text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem;
    }

    /* Mobile Adjustments */
    @media (max-width: 768px) {
        .conversation-row { grid-template-columns: 50px 1fr; padding: 1rem; }
        .conv-meta-desktop { display: none; }
        .conv-meta-mobile { display: block; }
        .avatar-circle { width: 40px; height: 40px; font-size: 1rem; }
        .conv-preview { white-space: normal; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    }
</style>
{% endblock %}
