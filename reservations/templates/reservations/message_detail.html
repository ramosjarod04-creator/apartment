{% extends 'base.html' %}

{% block title %}Chat with {{ other_user.username }} - Apartment Reservation{% endblock %}

{% block content %}
<div class="container chat-container">
    <div class="conversation-header">
        <a href="{% url 'inbox' %}" class="back-link">Back to Inbox</a>
        <div class="header-info">
            <div class="header-avatar">{{ other_user.username|slice:":1"|upper }}</div>
            <div class="header-text">
                <h2 class="header-name">{{ other_user.get_full_name|default:other_user.username }}</h2>
                <p class="header-subject">Re: {{ conversation.subject }}</p>
            </div>
        </div>
    </div>

    <div class="messages-thread" id="chatThread">
        {% for message in messages %}
        <div class="message-bubble {% if message.sender == user %}sent{% else %}received{% endif %}">
            <div class="bubble-content">
                <div class="bubble-text">
                    {{ message.content|linebreaksbr }}
                </div>
                <div class="bubble-meta">
                    <span class="bubble-time">{{ message.created_at|date:"g:i A" }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="reply-box">
        <form method="POST" class="reply-form">
            {% csrf_token %}
            <textarea 
                name="content" 
                class="reply-input" 
                rows="1" 
                required 
                placeholder="Write a message..."
                oninput='this.style.height = "";this.style.height = this.scrollHeight + "px"'
            ></textarea>
            <button type="submit" class="send-btn">Send</button>
        </form>
    </div>
</div>

<style>
    .chat-container { max-width: 800px; margin: 1rem auto; display: flex; flex-direction: column; height: calc(100vh - 120px); }

    /* Header */
    .conversation-header {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        border: 1px solid var(--gray-200);
    }

    .back-link { color: var(--primary); text-decoration: none; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; }

    .header-info { display: flex; align-items: center; gap: 12px; }
    .header-avatar {
        width: 40px; height: 40px; border-radius: 50%; background: var(--dark);
        color: white; display: flex; align-items: center; justify-content: center; font-weight: 800;
    }

    .header-name { font-size: 1.1rem; color: var(--dark); margin: 0; }
    .header-subject { margin: 0; color: var(--gray-500); font-size: 0.8rem; }

    /* Messages Thread */
    .messages-thread {
        flex: 1;
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        border: 1px solid var(--gray-200);
    }

    .message-bubble { max-width: 80%; display: flex; flex-direction: column; }
    .message-bubble.sent { align-self: flex-end; }
    .message-bubble.received { align-self: flex-start; }

    .bubble-content { padding: 10px 14px; border-radius: 18px; position: relative; font-size: 0.95rem; line-height: 1.4; }

    .message-bubble.sent .bubble-content {
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-bubble.received .bubble-content {
        background: white;
        color: var(--dark);
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .bubble-meta { font-size: 0.7rem; margin-top: 4px; opacity: 0.7; text-align: right; }
    .message-bubble.sent .bubble-meta { color: white; }

    /* Reply Box */
    .reply-box {
        background: white;
        padding: 1rem;
        border-radius: var(--radius-lg);
        margin-top: 1rem;
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-sm);
    }

    .reply-form { display: flex; gap: 10px; align-items: flex-end; }

    .reply-input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid var(--gray-300);
        border-radius: 20px;
        font-size: 1rem;
        resize: none;
        max-height: 120px;
        transition: border-color 0.2s;
    }

    .reply-input:focus { outline: none; border-color: var(--primary); }

    .send-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s;
    }

    .send-btn:hover { background: #1d4ed8; }

    /* Mobile */
    @media (max-width: 768px) {
        .chat-container { height: calc(100vh - 80px); margin: 0.5rem 0; }
        .conversation-header { gap: 0.75rem; padding: 0.75rem; }
        .back-link { font-size: 0.7rem; }
        .header-avatar { width: 32px; height: 32px; font-size: 0.9rem; }
        .messages-thread { padding: 1rem; }
        .message-bubble { max-width: 90%; }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const thread = document.getElementById('chatThread');
        thread.scrollTop = thread.scrollHeight;
    });
</script>
{% endblock %}
